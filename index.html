<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal RC Core | KDS 24 14 21 Professional</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --sidebar-w: 280px;
            --brand: #0f172a;
            --primary: #2563eb;
            --primary-light: #eff6ff;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text-h: #0f172a;
            --text-p: #475569;
            --text-m: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: var(--bg);
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: var(--text-h);
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-w);
            background: var(--brand);
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .brand-box {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .brand-logo {
            width: 32px;
            height: 32px;
            background: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
        }

        .case-mgmt {
            flex: 1;
            padding: 1.25rem;
            overflow-y: auto;
        }

        .case-mgmt h3 {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-m);
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
        }

        .case-item {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 0.4rem;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            color: var(--text-m);
        }

        .case-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .case-item.active {
            background: var(--primary);
            color: white;
        }

        .add-btn {
            width: 100%;
            border: 1px dashed #ffffff33;
            background: none;
            color: white;
            padding: 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            margin-top: 10px;
            cursor: pointer;
        }

        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .topbar {
            height: 60px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
        }

        .tabs {
            display: flex;
            gap: 1.5rem;
        }

        .tab-btn {
            height: 60px;
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-p);
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }

        .tab-btn.active {
            color: var(--primary);
            border-color: var(--primary);
        }

        .workspace {
            flex: 1;
            overflow: hidden;
            display: grid;
            grid-template-columns: 360px 1fr;
        }

        .config-pane {
            background: var(--surface);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            padding: 1.25rem;
        }

        .ctrl-group {
            margin-bottom: 1.5rem;
        }

        .ctrl-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-m);
            text-transform: uppercase;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.4rem;
            display: flex;
            justify-content: space-between;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            margin-bottom: 0.75rem;
        }

        .field label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-p);
        }

        .field input,
        .field select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
            outline: none;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        /* View Pane */
        .view-pane {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
            background: #f1f5f9;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .viz-box {
            min-height: 480px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 12px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }

        .met {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .met-lab {
            font-size: 0.75rem;
            color: var(--text-m);
            font-weight: 600;
        }

        .met-val {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--brand);
        }

        .badge {
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .badge-pass {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-fail {
            background: #fee2e2;
            color: #991b1b;
        }

        .chart-wrap {
            height: 500px;
        }

        .hidden {
            display: none !important;
        }

        /* Rebar Logic UI */
        .rebar-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr 1.5fr;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }

        .rebar-header {
            font-size: 0.65rem;
            color: var(--text-m);
            font-weight: 700;
            text-transform: uppercase;
        }

        .toggle-field {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .toggle-field input {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .toggle-field label {
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
        }

        .check-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.85rem;
        }

        .check-item:last-child {
            border-bottom: none;
        }

        .standard-mark {
            font-size: 0.65rem;
            color: var(--primary);
            font-weight: 800;
            border: 1px solid var(--primary);
            padding: 1px 4px;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <aside class="sidebar">
        <div class="brand-box">
            <div class="brand-logo">KDS</div>
            <div style="font-weight: 700; font-size: 1rem;">RC Design Core</div>
        </div>
        <div class="case-mgmt">
            <h3>Design Scenarios</h3>
            <div id="case-list"></div>
            <button class="add-btn" onclick="addNewCase()">+ New KDS Analysis</button>
        </div>
        <div style="margin-top: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 10px;">
            <div style="font-size: 0.65rem; color: #94a3b8; text-align: center; margin-bottom: 5px;">Compliant with KDS
                24 14 21</div>
            <button class="add-btn" style="background:#10b981; border:none;" onclick="generateReport()">Structural
                Report</button>
            <button class="add-btn" style="color:#ef4444; border:1px solid #ef444433; font-size: 0.7rem;"
                onclick="clearStorage()">⚠️ Factory Reset</button>
        </div>
    </aside>

    <main class="main">
        <header class="topbar">
            <div class="tabs">
                <div id="tab-analysis" class="tab-btn active" onclick="switchTab('analysis')">Cross-Section Engineering
                </div>
                <div id="tab-diagram" class="tab-btn" onclick="switchTab('diagram')">N-M Interaction Diagram</div>
            </div>
            <div style="display:flex; gap:12px; align-items:center;">
                <input id="active-case-name"
                    style="padding:4px 8px; border:1px solid var(--border); border-radius:4px; font-size:0.8rem; font-weight:600;"
                    onchange="syncCaseName()">
                <button id="calc-trigger"
                    style="background:var(--primary); color:white; border:none; padding:8px 18px; border-radius:6px; font-size:0.85rem; font-weight:600; cursor:pointer;"
                    onclick="run()">KDS Analyze</button>
            </div>
        </header>

        <section class="workspace">
            <div class="config-pane">
                <div class="ctrl-group">
                    <div class="ctrl-title"><span>Geometry</span><span class="standard-mark">KDS 24 14</span></div>
                    <div class="field">
                        <label>Section Shape</label>
                        <select id="geo-type" onchange="toggleToggles(); run();">
                            <option value="RECT">Rectangular / 사각형</option>
                            <option value="CIRC">Circular / 원형</option>
                        </select>
                    </div>

                    <div id="input-rect">
                        <div class="input-row">
                            <div class="field"><label>Width (b)</label><input type="number" id="b" value="400"
                                    oninput="run()"></div>
                            <div class="field"><label>Height (h)</label><input type="number" id="h" value="700"
                                    oninput="run()"></div>
                        </div>
                        <div class="toggle-field">
                            <input type="checkbox" id="rect-hollow" onchange="toggleToggles(); run();">
                            <label for="rect-hollow">Hollow / 중공 단면</label>
                        </div>
                        <div id="rect-hollow-inputs" class="input-row hidden">
                            <div class="field"><label>Inner b</label><input type="number" id="bi" value="300"
                                    oninput="run()"></div>
                            <div class="field"><label>Inner h</label><input type="number" id="hi" value="600"
                                    oninput="run()"></div>
                        </div>
                    </div>

                    <div id="input-circ" class="hidden">
                        <div class="field"><label>Outer Diameter (D)</label><input type="number" id="D_outer"
                                value="1000" oninput="run()"></div>
                        <div class="toggle-field">
                            <input type="checkbox" id="circ-hollow" onchange="toggleToggles(); run();">
                            <label for="circ-hollow">Hollow / 중공 단면</label>
                        </div>
                        <div id="circ-hollow-inputs" class="field hidden"><label>Inner Diameter (Di)</label><input
                                type="number" id="D_inner" value="600" oninput="run()"></div>
                    </div>
                </div>

                <div class="ctrl-group">
                    <div class="ctrl-title"><span>Reinforcement</span><span class="standard-mark">KDS 14 20</span></div>
                    <div id="rebar-rect">
                        <div class="rebar-grid">
                            <div class="rebar-header">Layer</div>
                            <div class="rebar-header">Count</div>
                            <div class="rebar-header">Dia</div>
                        </div>
                        <div class="rebar-grid">
                            <span style="font-size:0.75rem; font-weight:600;">Main (Bot)</span>
                            <input type="number" id="as_count" value="4" oninput="run()">
                            <select id="as_dia" onchange="run()">
                                <option value="12.7">D13</option>
                                <option value="15.9">D16</option>
                                <option value="19.1">D19</option>
                                <option value="22.2" selected>D22</option>
                                <option value="25.4">D25</option>
                                <option value="28.6">D29</option>
                                <option value="31.8">D32</option>
                            </select>
                        </div>
                        <div class="rebar-grid">
                            <span style="font-size:0.75rem; font-weight:600;">Upper (Top)</span>
                            <input type="number" id="asp_count" value="2" oninput="run()">
                            <select id="asp_dia" onchange="run()">
                                <option value="12.7">D13</option>
                                <option value="15.9">D16</option>
                                <option value="19.1" selected>D19</option>
                                <option value="22.2">D22</option>
                                <option value="25.4">D25</option>
                                <option value="28.6">D29</option>
                                <option value="31.8">D32</option>
                            </select>
                        </div>
                        <div class="input-row" style="margin-top:10px;">
                            <div class="field"><label>Cover (Bot)</label><input type="number" id="cover_bot" value="65"
                                    oninput="run()"></div>
                            <div class="field"><label>Cover (Top)</label><input type="number" id="cover_top" value="65"
                                    oninput="run()"></div>
                        </div>
                    </div>

                    <div id="rebar-circ" class="hidden">
                        <div class="rebar-grid">
                            <div class="rebar-header">Type</div>
                            <div class="rebar-header">Count</div>
                            <div class="rebar-header">Dia</div>
                        </div>
                        <div class="rebar-grid">
                            <span style="font-size:0.75rem; font-weight:600;">Perimeter</span>
                            <input type="number" id="circ_rebar_count" value="12" oninput="run()">
                            <select id="circ_rebar_dia" onchange="run()">
                                <option value="19.1">D19</option>
                                <option value="22.2" selected>D22</option>
                                <option value="25.4">D25</option>
                                <option value="28.6">D29</option>
                                <option value="31.8">D32</option>
                            </select>
                        </div>
                        <div class="field"><label>Net Cover (mm)</label><input type="number" id="circ_cover" value="80"
                                oninput="run()"></div>
                    </div>
                </div>

                <div class="ctrl-group">
                    <div class="ctrl-title"><span>Materials</span><span class="standard-mark">Compliant</span></div>
                    <div class="input-row">
                        <div class="field"><label>fck (MPa)</label><input type="number" id="fck" value="30"
                                oninput="run()"></div>
                        <div class="field"><label>fy (MPa)</label><input type="number" id="fy" value="400"
                                oninput="run()"></div>
                    </div>
                    <div class="field"><label>Service Loading Pu (kN)</label><input type="number" id="p_applied"
                            value="0" oninput="run()"></div>
                </div>
            </div>

            <div class="view-pane">
                <div id="view-analysis">
                    <div style="display:grid; grid-template-columns: 1fr 320px; gap: 1.5rem;">
                        <div class="viz-box"><svg id="viz-svg" width="340" height="450" viewBox="0 0 340 450"></svg>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:1.5rem;">
                            <div class="card">
                                <div class="ctrl-title" style="margin-bottom:1rem;">KDS Design Checks</div>
                                <div class="check-item"><span>Min Reinforcement</span><span id="chk-min-as"
                                        class="badge">N/A</span></div>
                                <div class="check-item"><span>Max Reinforcement</span><span id="chk-max-as"
                                        class="badge">N/A</span></div>
                                <div class="check-item"><span>Steel Strain (εt)</span><span id="res-st-strain"
                                        style="font-weight:700;">-</span></div>
                                <div class="check-item"><span>Phi (φ) KDS Factor</span><span id="res-phi"
                                        style="font-weight:800; color:var(--primary);">0.85</span></div>
                            </div>
                            <div class="card">
                                <div class="ctrl-title" style="margin-bottom:1rem;">Material Status</div>
                                <div class="check-item"><span>Conc. Max Stress</span><span id="res-conc-stress"
                                        style="color:var(--text-p);">25.5 MPa</span></div>
                                <div class="check-item"><span>Neutral Depth Ratio</span><span id="res-c-ratio"
                                        style="color:var(--text-p);">0.34</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="results-grid" style="margin-top: 1.5rem;">
                        <div class="card met"><span class="met-lab">Design Moment (φMn)</span><span class="met-val"
                                id="res-phimn">0.00 kNm</span></div>
                        <div class="card met"><span class="met-lab">Nominal Moment (Mn)</span><span class="met-val"
                                id="res-mn" style="font-size:0.95rem; color:var(--text-m);">0.00 kNm</span></div>
                        <div class="card met"><span class="met-lab">Neutral Axis (c)</span><span class="met-val"
                                id="res-c">0.0 mm</span></div>
                        <div class="card met"><span class="met-lab">Reinforc. Area (As)</span><span class="met-val"
                                id="res-as-total">0 mm²</span></div>
                    </div>

                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="ctrl-title" style="margin-bottom:1rem;">Detailed Calculation Trace (Analytical)
                        </div>
                        <div id="calc-trace-container"
                            style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; line-height: 1.6; color: #475569;">
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                <div>- Concrete Compression Force (Cc): <span id="trace-Cc">0.0</span> kN</div>
                                <div>- Steel Tension Force (Ts): <span id="trace-Ts">0.0</span> kN</div>
                                <div>- Steel Compression (Cs): <span id="trace-Cs">0.0</span> kN</div>
                                <div>- Internal Equilibrium (ΣF): <span id="trace-error">0.0</span> kN</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="view-diagram" class="hidden">
                    <div class="card chart-wrap"><canvas id="nm-canvas"></canvas></div>
                </div>
            </div>
        </section>
    </main>

    <script>
        const DIA_MAP = { "12.7": 126.7, "15.9": 198.6, "19.1": 286.5, "22.2": 387.1, "25.4": 506.7, "28.6": 642.4, "31.8": 794.2 };

        class KDSEngine {
            constructor() { this.fibers = []; this.rebars = []; this.h = 0; this.trace = {}; }
            clear() { this.fibers = []; this.rebars = []; }

            setRect(b, h, bi = 0, hi = 0) {
                this.clear(); const n = 150; const dy = h / n;
                for (let i = 0; i < n; i++) {
                    const y = i * dy + dy / 2; let w = b;
                    if (bi > 0 && hi > 0 && y > (h - hi) / 2 && y < (h + hi) / 2) w -= bi;
                    if (w > 0) this.fibers.push({ y, area: w * dy, w });
                } this.h = h;
            }
            setCirc(D, Di = 0) {
                this.clear(); const n = 180; const dy = D / n; const R = D / 2, Ri = Di / 2;
                for (let i = 0; i < n; i++) {
                    const y = i * dy + dy / 2; const dist = Math.abs(y - R);
                    let w = (dist < R) ? 2 * Math.sqrt(R * R - dist ** 2) : 0;
                    if (Di > 0 && dist < Ri) w -= 2 * Math.sqrt(Ri * Ri - dist ** 2);
                    if (w > 0) this.fibers.push({ y, area: w * dy, w });
                } this.h = D;
            }

            analyze(fck, fy, targetP = 0) {
                const Es = 200000, ecu = 0.0033;
                let cl = 0.1, cr = this.h * 12, c = this.h / 3;

                const stress = (e) => {
                    if (e <= 0) return 0;
                    const ec0 = 0.002;
                    if (e < ec0) return 0.85 * fck * (2 * (e / ec0) - (e / ec0) ** 2);
                    if (e <= 0.0033) return 0.85 * fck;
                    return 0;
                };

                for (let i = 0; i < 100; i++) {
                    c = (cl + cr) / 2; let P = 0;
                    this.fibers.forEach(f => P += stress(ecu * (c - (this.h - f.y)) / c) * f.area);
                    this.rebars.forEach(r => {
                        const e = ecu * (c - (this.h - r.y)) / c;
                        P -= Math.min(fy, Math.abs(e * Es)) * Math.sign(e) * r.area;
                    });
                    if (Math.abs(P - targetP) < 5) break;
                    if (P > targetP) cr = c; else cl = c;
                }

                let Mn = 0;
                let Cc = 0, Cs = 0, Ts = 0;
                this.fibers.forEach(f => {
                    const s = stress(ecu * (c - (this.h - f.y)) / c);
                    Cc += s * f.area;
                    Mn += s * f.area * (f.y - (this.h - c));
                });
                this.rebars.forEach(r => {
                    const e = ecu * (c - (this.h - r.y)) / c;
                    const force = Math.min(fy, Math.abs(e * Es)) * Math.sign(e) * r.area;
                    if (force < 0) Ts += Math.abs(force); else Cs += force;
                    Mn -= force * (r.y - (this.h - c));
                });

                const d_extreme = Math.min(...this.rebars.map(r => r.y));
                const et = ecu * (c - d_extreme) / c;
                const ey = fy / Es;
                let phi = 0.65;
                if (et >= 0.005) phi = 0.85;
                else if (et > ey) phi = 0.65 + (et - ey) * (0.85 - 0.65) / (0.005 - ey);

                this.trace = { Cc: Cc / 1000, Cs: Cs / 1000, Ts: Ts / 1000, c, et, Mn: Mn / 1e6, phi };
                return { Mn: Mn / 1e6, c, phi, et, maxStress: 0.85 * fck };
            }

            getNMPoints(fck, fy) {
                const pts = []; const ecu = 0.0033, Es = 200000;
                const stress = (e) => (e <= 0 ? 0 : (e <= 0.002 ? 0.85 * fck * (2 * (e / 0.002) - (e / 0.002) ** 2) : 0.85 * fck));
                for (let i = 0; i <= 60; i++) {
                    const c = (this.h / 60) * i + 0.1; let P = 0, M = 0;
                    this.fibers.forEach(f => { const s = stress(ecu * (c - (this.h - f.y)) / c); P += s * f.area; M += s * f.area * (f.y - this.h / 2); });
                    this.rebars.forEach(r => { const e = ecu * (c - (this.h - r.y)) / c; const s = Math.min(fy, Math.abs(e * Es)) * Math.sign(e); P -= s * r.area; M -= s * r.area * (r.y - this.h / 2); });
                    pts.push({ x: Math.abs(M / 1e6), y: P / 1e3 });
                } return pts.sort((a, b) => a.y - b.y);
            }
        }

        let cases = JSON.parse(localStorage.getItem('rc_kds_cases')) || [{ name: 'KDS Beam A', type: 'RECT', data: { b: 400, h: 700, fck: 30, fy: 400, as_count: 5, as_dia: '25.4', asp_count: 2, asp_dia: '19.1', cover_bot: 65, cover_top: 65, circ_rebar_count: 14, circ_rebar_dia: '22.2', circ_cover: 80, D_outer: 1000, D_inner: 600, bi: 300, hi: 600, isRectHollow: false, isCircHollow: false } }];
        let activeIdx = 0;
        const engine = new KDSEngine();
        let chart = null;

        // Interaction state
        let isDragging = false, dragPart = null;

        function run() {
            try {
                const c = cases[activeIdx]; c.type = document.getElementById('geo-type').value;
                const inputs = ['b', 'h', 'bi', 'hi', 'D_outer', 'D_inner', 'fck', 'fy', 'p_applied', 'as_count', 'asp_count', 'cover_bot', 'cover_top', 'circ_rebar_count', 'circ_cover'];
                inputs.forEach(id => { if (document.getElementById(id)) c.data[id] = parseFloat(document.getElementById(id).value) || 0; });
                c.data.as_dia = document.getElementById('as_dia')?.value || "22.2";
                c.data.asp_dia = document.getElementById('asp_dia')?.value || "19.1";
                c.data.circ_rebar_dia = document.getElementById('circ_rebar_dia')?.value || "22.2";
                c.data.isRectHollow = document.getElementById('rect-hollow').checked;
                c.data.isCircHollow = document.getElementById('circ-hollow').checked;
                localStorage.setItem('rc_kds_cases', JSON.stringify(cases));

                const d = c.data;
                engine.rebars = [];
                let totalAs = 0;
                let d_effective = 0;

                if (c.type === 'RECT') {
                    engine.setRect(d.b, d.h, d.isRectHollow ? d.bi : 0, d.isRectHollow ? d.hi : 0);
                    if (d.as_count > 0) { const a = d.as_count * DIA_MAP[d.as_dia]; engine.rebars.push({ y: d.cover_bot, area: a, count: d.as_count, dia: parseFloat(d.as_dia) }); totalAs += a; }
                    if (d.asp_count > 0) { const a = d.asp_count * DIA_MAP[d.asp_dia]; engine.rebars.push({ y: d.h - d.cover_top, area: a, count: d.asp_count, dia: parseFloat(d.asp_dia) }); totalAs += a; }
                    d_effective = d.h - d.cover_bot;
                } else {
                    engine.setCirc(d.D_outer, d.isCircHollow ? d.D_inner : 0);
                    const a_each = DIA_MAP[d.circ_rebar_dia];
                    const R_rebar = (d.D_outer / 2) - d.circ_cover;
                    for (let i = 0; i < d.circ_rebar_count; i++) {
                        const angle = (2 * Math.PI / d.circ_rebar_count) * i;
                        const ry = (d.D_outer / 2) + R_rebar * Math.cos(angle);
                        engine.rebars.push({ y: ry, area: a_each, count: 1, dia: parseFloat(d.circ_rebar_dia), rx: (d.D_outer / 2) + R_rebar * Math.sin(angle) });
                    }
                    totalAs = d.circ_rebar_count * a_each;
                    d_effective = (d.D_outer / 2) + R_rebar;
                }

                const res = engine.analyze(d.fck, d.fy, d.p_applied * 1000);

                document.getElementById('res-phimn').innerText = (res.Mn * res.phi).toFixed(2) + " kNm";
                document.getElementById('res-mn').innerText = "Mn: " + res.Mn.toFixed(2) + " kNm";
                document.getElementById('res-phi').innerText = res.phi.toFixed(3);
                document.getElementById('res-st-strain').innerText = res.et.toFixed(5);
                document.getElementById('res-c').innerText = res.c.toFixed(1) + " mm";
                document.getElementById('res-c-ratio').innerText = (d_effective > 0 ? (res.c / d_effective).toFixed(2) : "0.00");
                document.getElementById('res-as-total').innerText = Math.round(totalAs) + " mm²";
                document.getElementById('res-conc-stress').innerText = res.maxStress.toFixed(1) + " MPa";

                // Update Trace UI
                const tr = engine.trace;
                document.getElementById('trace-Cc').innerText = tr.Cc.toFixed(1);
                document.getElementById('trace-Ts').innerText = tr.Ts.toFixed(1);
                document.getElementById('trace-Cs').innerText = tr.Cs.toFixed(1);
                document.getElementById('trace-error').innerText = (tr.Cc + tr.Cs - tr.Ts - d.p_applied).toFixed(1);

                const rho = d_effective > 0 ? totalAs / (d.b * d_effective) : 0;
                const rho_min = Math.max(0.25 * Math.sqrt(d.fck) / d.fy, 1.4 / d.fy);

                const minBadge = document.getElementById('chk-min-as');
                if (rho >= rho_min) { minBadge.innerText = "PASS"; minBadge.className = "badge badge-pass"; }
                else { minBadge.innerText = "LOW"; minBadge.className = "badge badge-fail"; }

                const maxBadge = document.getElementById('chk-max-as');
                if (res.et >= 0.004) { maxBadge.innerText = "PASS"; maxBadge.className = "badge badge-pass"; }
                else { maxBadge.innerText = "FAIL"; maxBadge.className = "badge badge-fail"; }

                drawSVG(res.c);
                drawNM();
            } catch (e) {
                console.error(e);
            }
        }

        function drawDim(x1, y1, x2, y2, label, offset, side = 'right') {
            const sc = 340 / Math.max(engine.h, 600);
            let htm = '';
            if (side === 'right') {
                const lx = x1 + offset;
                htm += `<line x1="${lx}" y1="${y1}" x2="${lx}" y2="${y2}" stroke="#94a3b8" stroke-width="1" />`;
                htm += `<line x1="${lx - 5}" y1="${y1}" x2="${lx + 5}" y2="${y1}" stroke="#94a3b8" />`;
                htm += `<line x1="${lx - 5}" y1="${y2}" x2="${lx + 5}" y2="${y2}" stroke="#94a3b8" />`;
                htm += `<text x="${lx + 10}" y="${(y1 + y2) / 2}" font-size="10" fill="#64748b" dominant-baseline="middle" font-weight="600">${label}</text>`;
            } else if (side === 'bottom') {
                const ly = y2 + offset;
                htm += `<line x1="${x1}" y1="${ly}" x2="${x2}" y2="${ly}" stroke="#94a3b8" stroke-width="1" />`;
                htm += `<line x1="${x1}" y1="${ly - 5}" x2="${x1}" y2="${ly + 5}" stroke="#94a3b8" />`;
                htm += `<line x1="${x2}" y1="${ly - 5}" x2="${x2}" y2="${ly + 5}" stroke="#94a3b8" />`;
                htm += `<text x="${(x1 + x2) / 2}" y="${ly + 15}" font-size="10" fill="#64748b" text-anchor="middle" font-weight="600">${label}</text>`;
            }
            return htm;
        }

        function drawSVG(c_na) {
            const svg = document.getElementById('viz-svg');
            const sc = 340 / Math.max(engine.h, 600);
            const H = engine.h;
            const d = cases[activeIdx].data;
            let htm = `<rect x="0" y="0" width="340" height="450" fill="#fff" onmousemove="handleSVGMove(event)" onmouseup="handleSVGUp(event)"/>`;

            // Concrete Fibers
            engine.fibers.forEach(f => {
                const sw = f.w * sc;
                htm += `<rect x="${(340 - sw) / 2}" y="${(H - f.y - (H / engine.fibers.length) / 2) * sc + 20}" width="${sw}" height="${(H / engine.fibers.length) * sc}" fill="#f1f5f9" />`;
            });

            // Dimensions
            if (cases[activeIdx].type === 'RECT') {
                const bw = d.b * sc, bh = d.h * sc;
                const ox = (340 - bw) / 2;
                htm += drawDim(ox + bw, 20, ox + bw, 20 + bh, `h=${d.h}`, 20, 'right');
                htm += drawDim(ox, 20 + bh, ox + bw, 20 + bh, `b=${d.b}`, 20, 'bottom');
            } else {
                const diam = d.D_outer * sc;
                htm += drawDim(170 - diam / 2, 20 + diam, 170 + diam / 2, 20 + diam, `D=${d.D_outer}`, 20, 'bottom');
            }

            // Neutral Axis
            const na_y = (H - (H - c_na)) * sc + 20;
            htm += `<line x1="10" y1="${na_y}" x2="330" y2="${na_y}" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="8,4" />`;
            htm += `<text x="330" y="${na_y - 8}" text-anchor="end" font-size="11" fill="#ef4444" font-weight="800">Neutral Axis c=${c_na.toFixed(1)}</text>`;

            // Rebars
            engine.rebars.forEach(r => {
                const ry = (H - r.y) * sc + 20; const rd = r.dia * sc;
                if (cases[activeIdx].type === 'RECT') {
                    let useW = d.b * 0.7; let sx = (340 - useW * sc) / 2;
                    let step = r.count > 1 ? (useW * sc) / (r.count - 1) : 0;
                    for (let i = 0; i < r.count; i++) htm += `<circle cx="${(r.count === 1 ? 170 : sx + i * step)}" cy="${ry}" r="${rd / 2}" fill="#1e293b" />`;
                } else htm += `<circle cx="${(r.rx - (H / 2)) * sc + 170}" cy="${ry}" r="${rd / 2}" fill="#1e293b" />`;
            });

            // Handles for Resize
            if (cases[activeIdx].type === 'RECT') {
                const bw = d.b * sc, bh = d.h * sc;
                const ox = (340 - bw) / 2;
                htm += `<rect x="${ox + bw - 5}" y="${20}" width="10" height="${bh}" fill="transparent" style="cursor:ew-resize" onmousedown="isDragging=true; dragPart='b'; event.stopPropagation();" />`;
                htm += `<rect x="${ox}" y="${20 + bh - 5}" width="${bw}" height="10" fill="transparent" style="cursor:ns-resize" onmousedown="isDragging=true; dragPart='h'; event.stopPropagation();" />`;
            } else {
                const diam = d.D_outer * sc;
                htm += `<circle cx="${170 + diam / 2}" cy="${20 + diam / 2}" r="15" fill="transparent" style="cursor:nwse-resize" onmousedown="isDragging=true; dragPart='D'; event.stopPropagation();" />`;
            }

            svg.innerHTML = htm;
        }

        function handleSVGMove(e) {
            if (!isDragging) return;
            const svg = document.getElementById('viz-svg');
            const rect = svg.getBoundingClientRect();
            const x = e.clientX - rect.left, y = e.clientY - rect.top;
            const c = cases[activeIdx];
            const sc = 340 / Math.max(engine.h, 600);

            if (dragPart === 'b') {
                const bw = (x - 170) * 2 / sc;
                if (bw > 50) { c.data.b = Math.round(bw); document.getElementById('b').value = c.data.b; }
            } else if (dragPart === 'h') {
                const bh = (y - 20) / sc;
                if (bh > 50) { c.data.h = Math.round(bh); document.getElementById('h').value = c.data.h; }
            } else if (dragPart === 'D') {
                const diam = (x - 170) * 2 / sc;
                if (diam > 50) { c.data.D_outer = Math.round(diam); document.getElementById('D_outer').value = c.data.D_outer; }
            }
            run();
        }
        function handleSVGUp() { isDragging = false; dragPart = null; }

        function generateReport() {
            const c = cases[activeIdx]; const d = c.data;
            const t = engine.trace;
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(`
                <html>
                <head>
                    <title>KDS 24 14 21 Structural Report - ${c.name}</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; padding: 50px; color: #1e293b; line-height: 1.6; }
                        header { border-bottom: 2px solid #2563eb; padding-bottom: 20px; margin-bottom: 40px; display: flex; justify-content: space-between; align-items: flex-end; }
                        h1 { font-size: 24px; margin: 0; color: #0f172a; }
                        .scen { font-size: 14px; color: #64748b; }
                        .card { border: 1px solid #e2e8f0; border-radius: 8px; padding: 25px; margin-bottom: 30px; }
                        h2 { font-size: 18px; color: #2563eb; margin-top: 0; border-left: 4px solid #2563eb; padding-left: 12px; }
                        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
                        .lbl { font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; }
                        .val { font-family: 'JetBrains Mono', monospace; font-weight: 700; }
                        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                        th, td { border: 1px solid #e2e8f0; padding: 12px; text-align: left; font-size: 13px; }
                        th { background: #f8fafc; font-weight: 700; color: #475569; }
                        .formula { background: #f1f5f9; padding: 15px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 13px; margin: 10px 0; border-left: 3px solid #cbd5e1; }
                    </style>
                </head>
                <body>
                    <header>
                        <div><h1>Structural Design Sheet</h1><span class="scen">KDS 24 14 21 RC Design Code</span></div>
                        <div style="text-align:right"><span>${c.name}</span><br><span style="font-size:12px">${new Date().toLocaleDateString()}</span></div>
                    </header>

                    <div class="card">
                        <h2>1. Design Geometry & Parameters</h2>
                        <div class="grid">
                            <div><div class="lbl">Section Shape</div><div class="val">${c.type}</div></div>
                            <div><div class="lbl">Section Height (h)</div><div class="val">${d.h || d.D_outer} mm</div></div>
                            <div><div class="lbl">Section Width (b)</div><div class="val">${d.b || d.D_outer} mm</div></div>
                        </div>
                        <div class="grid">
                            <div><div class="lbl">Concrete Strength (fck)</div><div class="val">${d.fck} MPa</div></div>
                            <div><div class="lbl">Steel Yield (fy)</div><div class="val">${d.fy} MPa</div></div>
                            <div><div class="lbl">Applied Axial (Pu)</div><div class="val">${d.p_applied} kN</div></div>
                        </div>
                    </div>

                    <div class="card">
                        <h2>2. Detailed Calculation Process (Equilibrium)</h2>
                        <div class="formula">
                            Step 1: Fiber-based Discretization Methods (N=150)<br>
                            Step 2: Concrete Stress Model (KDS Parabolic-Rectangular)<br>
                            Step 3: Resolve Forces (ΣF = 0)<br>
                            &nbsp;&nbsp;&nbsp;- Conc. Comp (Cc) = ∫ σc dA ≈ ${t.Cc.toFixed(1)} kN<br>
                            &nbsp;&nbsp;&nbsp;- Steel Tension (Ts) = Σ (Asi * σsi) ≈ ${t.Ts.toFixed(1)} kN<br>
                            &nbsp;&nbsp;&nbsp;- Target Axial Load P = ${d.p_applied} kN
                        </div>
                        <p>Neutral Axis depth (c): <b>${t.c.toFixed(1)} mm</b></p>
                        <p>Extreme Tensile Strain (εt): <b>${t.et.toFixed(5)}</b></p>
                    </div>

                    <div class="card">
                        <h2>3. Design Strength Summary</h2>
                        <table>
                            <tr><th>Metric</th><th>Calculation Logic</th><th>Result</th></tr>
                            <tr><td>Nominal Moment (Mn)</td><td>Σ (Fi * zi) about centroid</td><td class="val">${t.Mn.toFixed(2)} kNm</td></tr>
                            <tr><td>Safety Factor (φ)</td><td>Strain-based transition</td><td class="val">${t.phi.toFixed(3)}</td></tr>
                            <tr><td><b>Design Strength (φMn)</b></td><td><b>φ * Mn</b></td><td class="val" style="color:#2563eb; font-size:16px">${(t.Mn * t.phi).toFixed(2)} kNm</td></tr>
                        </table>
                    </div>

                    <footer style="margin-top:50px; text-align:center; font-size:11px; color:#94a3b8">
                        Analytical verification completed via Universal RC Core Engine (Fiber Method).
                    </footer>
                    <script>window.print();<\/script>
                </body>
                </html>
            `);
            reportWindow.document.close();
        }

        window.onload = () => loadCase(0);
    </script>
</body>

</html>